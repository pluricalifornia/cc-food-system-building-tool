<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Coast Food System Network Matcher</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #mapDiv {
            height: 600px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-green-800 mb-4">
                Central Coast Food System Network Matcher
            </h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-6">
                Interactive map of 100 organizations across 6 Central Coast counties
            </p>
            
            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <button onclick="toggleNetworkView()" id="btnNetwork" class="btn px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white">
                    Toggle Network View
                </button>
                <button onclick="exportOrganizations()" class="btn px-6 py-2 rounded-lg font-semibold bg-purple-600 text-white">
                    Export Organizations
                </button>
                <button onclick="exportMatches()" class="btn px-6 py-2 rounded-lg font-semibold bg-indigo-600 text-white">
                    Export Matches
                </button>
            </div>
        </div>

        <div id="mainView">
            <div id="mapDiv" class="w-full rounded-lg shadow-lg border-4 border-white mb-6"></div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4">Organization Types</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(34, 139, 34);"></div>
                        <span>Farmer/Producer</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(255, 140, 0);"></div>
                        <span>Processor</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(30, 144, 255);"></div>
                        <span>Distributor</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(147, 112, 219);"></div>
                        <span>Nonprofit</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(220, 20, 60);"></div>
                        <span>Education</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(255, 215, 0);"></div>
                        <span>Cooperative</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(64, 224, 208);"></div>
                        <span>Service Provider</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4">Quick Stats</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-3xl font-bold text-green-700">100</div>
                        <div class="text-sm text-gray-600">Organizations</div>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-3xl font-bold text-blue-700">6</div>
                        <div class="text-sm text-gray-600">Counties</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-3xl font-bold text-purple-700" id="totalMatches">0</div>
                        <div class="text-sm text-gray-600">Potential Matches</div>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                <h4 class="font-bold text-blue-900 mb-2">GitHub Repository</h4>
                <div class="text-sm text-blue-800 space-y-2">
                    <p><strong>Repository:</strong> pluricalifornia/cc-food-system-building-tool</p>
                    <p><strong>Live Site:</strong> https://pluricalifornia.github.io/cc-food-system-building-tool</p>
                    <p><strong>County Data:</strong> Loaded from data/CA_COUNTIES.json</p>
                </div>
            </div>
        </div>

        <div id="matchView" class="hidden">
            <button onclick="showMapView()" class="text-green-600 hover:text-green-800 font-semibold flex items-center gap-2 mb-6 text-lg">
                Back to Map
            </button>
            <div id="matchContent"></div>
        </div>
    </div>

    <script>
        let appState = {
            organizations: [],
            countyBoundaries: {},
            view: null,
            layers: {
                boundary: null,
                network: null,
                org: null
            },
            showNetwork: false,
            selectedOrg: null
        };

        const countyLocations = {
            "Monterey County": { lat: 36.4, lng: -121.3, bounds: { minLat: 35.8, maxLat: 37.0, minLng: -122.0, maxLng: -120.2 } },
            "Santa Cruz County": { lat: 37.0, lng: -122.0, bounds: { minLat: 36.8, maxLat: 37.3, minLng: -122.3, maxLng: -121.6 } },
            "San Benito County": { lat: 36.6, lng: -121.0, bounds: { minLat: 36.2, maxLat: 36.9, minLng: -121.5, maxLng: -120.4 } },
            "Santa Barbara County": { lat: 34.5, lng: -120.0, bounds: { minLat: 34.4, maxLat: 35.0, minLng: -120.7, maxLng: -119.5 } },
            "San Luis Obispo County": { lat: 35.3, lng: -120.5, bounds: { minLat: 35.0, maxLat: 35.8, minLng: -121.3, maxLng: -119.8 } },
            "Ventura County": { lat: 34.4, lng: -119.1, bounds: { minLat: 34.0, maxLat: 34.7, minLng: -119.5, maxLng: -118.6 } }
        };

        const typeColors = {
            "Farmer/Fisher/Food Producer": [34, 139, 34],
            "Food Processor": [255, 140, 0],
            "Distributor": [30, 144, 255],
            "Nonprofit Organization": [147, 112, 219],
            "Educational Institution": [220, 20, 60],
            "Cooperative": [255, 215, 0],
            "For-profit Service Provider": [64, 224, 208]
        };

        const countyColors = {
            'Monterey': '#2E86AB',
            'Santa Cruz': '#A23B72',
            'Santa Barbara': '#F18F01',
            'San Benito': '#C73E1D',
            'Ventura': '#5D737E',
            'San Luis Obispo': '#7A4F9A'
        };

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16)
            ] : [200, 200, 200];
        }

        function isPointInPolygon(point, polygon) {
            const [x, y] = point;
            let inside = false;
            for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
                const [xi, yi] = polygon[i];
                const [xj, yj] = polygon[j];
                if (((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) {
                    inside = !inside;
                }
            }
            return inside;
        }

        function generateLocation(county) {
            const boundary = appState.countyBoundaries[county];
            
            if (boundary && boundary.length > 0) {
                let minLng = Infinity, maxLng = -Infinity;
                let minLat = Infinity, maxLat = -Infinity;
                
                boundary.forEach(coord => {
                    minLng = Math.min(minLng, coord[0]);
                    maxLng = Math.max(maxLng, coord[0]);
                    minLat = Math.min(minLat, coord[1]);
                    maxLat = Math.max(maxLat, coord[1]);
                });
                
                for (let i = 0; i < 100; i++) {
                    const point = [
                        minLng + Math.random() * (maxLng - minLng),
                        minLat + Math.random() * (maxLat - minLat)
                    ];
                    if (isPointInPolygon(point, boundary)) {
                        return { lat: point[1], lng: point[0] };
                    }
                }
            }
            
            const bounds = countyLocations[county]?.bounds || { minLat: 35, maxLat: 36, minLng: -121, maxLng: -120 };
            return {
                lat: bounds.minLat + Math.random() * (bounds.maxLat - bounds.minLat),
                lng: bounds.minLng + Math.random() * (bounds.maxLng - bounds.minLng)
            };
        }

        function generateOrganizations() {
            const orgTypes = [
                "Farmer/Fisher/Food Producer", "Food Processor", "Distributor",
                "Nonprofit Organization", "Educational Institution", "Cooperative",
                "For-profit Service Provider"
            ];
            const counties = Object.keys(countyLocations);
            const needsPool = [
                "Cold storage facility access", "Marketing and brand development",
                "Grant writing and fundraising", "Transportation and delivery services",
                "Business planning and strategy", "Processing and packaging capabilities",
                "Food safety certification", "Technology integration",
                "Access to capital/loan assistance", "Distribution and logistics planning"
            ];
            const resourcesPool = [
                "Production planning and crop scheduling", "Sustainable farming practices",
                "Cold storage facility access", "Transportation and delivery services",
                "Marketing and brand development", "Grant writing and fundraising",
                "Business planning and strategy", "Processing and packaging capabilities"
            ];
            const orgNames = ["Valley", "Coast", "Pacific", "Central", "Regional", "Community"];
            const orgSuffixes = ["Farm", "Co-op", "Processors", "Hub", "Distributors", "Services"];

            const orgs = [];
            for (let i = 0; i < 100; i++) {
                const county = counties[Math.floor(Math.random() * counties.length)];
                const location = generateLocation(county);
                
                const selectedNeeds = {};
                const shuffledNeeds = [...needsPool].sort(() => Math.random() - 0.5);
                for (let j = 0; j < 3; j++) {
                    selectedNeeds[shuffledNeeds[j]] = ["High", "Moderate", "Low"][Math.floor(Math.random() * 3)];
                }

                const selectedResources = {};
                const shuffledResources = [...resourcesPool].sort(() => Math.random() - 0.5);
                for (let j = 0; j < 3; j++) {
                    selectedResources[shuffledResources[j]] = ["Extensive", "Some"][Math.floor(Math.random() * 2)];
                }

                const topNeeds = Object.entries(selectedNeeds)
                    .filter(([_, level]) => level === "High" || level === "Moderate")
                    .slice(0, 3).map(([key, _]) => key);
                const topResources = Object.entries(selectedResources)
                    .slice(0, 3).map(([key, _]) => key);

                orgs.push({
                    id: i + 1,
                    name: `${orgNames[Math.floor(Math.random() * orgNames.length)]} ${orgSuffixes[Math.floor(Math.random() * orgSuffixes.length)]}`,
                    type: orgTypes[Math.floor(Math.random() * orgTypes.length)],
                    county: county,
                    lat: location.lat,
                    lng: location.lng,
                    needs: selectedNeeds,
                    resources: selectedResources,
                    topNeeds: topNeeds,
                    topResources: topResources
                });
            }
            return orgs;
        }

        function calculateMatch(org1, org2) {
            let score = 0;
            let matches = [];
            Object.keys(org1.needs).forEach(need => {
                if (org2.resources[need] && (org1.needs[need] === "High" || org1.needs[need] === "Moderate")) {
                    const weight = org1.needs[need] === "High" ? 3 : 2;
                    const resourceLevel = org2.resources[need] === "Extensive" ? 3 : 2;
                    score += weight * resourceLevel;
                    matches.push({
                        type: "need-resource",
                        item: need,
                        needLevel: org1.needs[need],
                        resourceLevel: org2.resources[need]
                    });
                }
            });
            if (org1.county === org2.county) score += 5;
            return { score, matches };
        }

        function getMatches(orgId) {
            const org = appState.organizations.find(o => o.id === orgId);
            return appState.organizations
                .filter(o => o.id !== orgId)
                .map(o => ({ org: o, matchData: calculateMatch(org, o) }))
                .filter(m => m.matchData.score > 0)
                .sort((a, b) => b.matchData.score - a.matchData.score);
        }

        function initMap() {
            require([
                "esri/Map", "esri/views/MapView", "esri/Graphic", "esri/layers/GraphicsLayer",
                "esri/geometry/Point", "esri/geometry/Polyline", "esri/geometry/Polygon",
                "esri/symbols/SimpleMarkerSymbol", "esri/symbols/SimpleLineSymbol",
                "esri/symbols/SimpleFillSymbol", "esri/PopupTemplate"
            ], function(Map, MapView, Graphic, GraphicsLayer, Point, Polyline, Polygon,
                       SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, PopupTemplate) {
                
                const map = new Map({ basemap: "streets-navigation-vector" });
                appState.view = new MapView({
                    container: "mapDiv",
                    map: map,
                    center: [-121.0, 35.5],
                    zoom: 7
                });

                appState.layers.boundary = new GraphicsLayer();
                appState.layers.network = new GraphicsLayer();
                appState.layers.org = new GraphicsLayer();
                
                map.add(appState.layers.boundary);
                map.add(appState.layers.network);
                map.add(appState.layers.org);

                appState.view.when(() => {
                    fetch('https://raw.githubusercontent.com/pluricalifornia/cc-food-system-building-tool/main/data/CA_COUNTIES.json')
                        .then(r => r.json())
                        .then(data => {
                            const central = ['Monterey', 'Santa Cruz', 'Santa Barbara', 'San Benito', 'Ventura', 'San Luis Obispo'];
                            data.features.forEach((f, i) => {
                                const name = f.properties.NAME;
                                if (!central.includes(name)) return;
                                
                                const coords = f.geometry.type === 'Polygon' ? 
                                    f.geometry.coordinates[0] : f.geometry.coordinates[0][0];
                                appState.countyBoundaries[name] = coords.map(c => [c[0], c[1]]);
                                
                                const geom = new Polygon({
                                    rings: f.geometry.type === 'Polygon' ? f.geometry.coordinates : f.geometry.coordinates[0],
                                    spatialReference: { wkid: 4326 }
                                });
                                const color = hexToRgb(countyColors[name] || '#cccccc');
                                appState.layers.boundary.add(new Graphic({
                                    geometry: geom,
                                    symbol: new SimpleFillSymbol({
                                        color: [...color, 0.2],
                                        outline: { color: [...color, 0.8], width: 2 }
                                    })
                                }));
                            });
                            
                            appState.organizations = generateOrganizations();
                            
                            appState.organizations.forEach(org => {
                                appState.layers.org.add(new Graphic({
                                    geometry: new Point({ longitude: org.lng, latitude: org.lat }),
                                    symbol: new SimpleMarkerSymbol({
                                        color: typeColors[org.type] || [128, 128, 128],
                                        size: "10px",
                                        outline: { color: [255, 255, 255], width: 2 }
                                    }),
                                    attributes: org,
                                    popupTemplate: new PopupTemplate({
                                        title: org.name,
                                        content: `<b>Type:</b> ${org.type}<br><b>County:</b> ${org.county}<br><b>Top Needs:</b><br>${org.topNeeds.map(n => `• ${n}`).join('<br>')}`
                                    })
                                }));
                            });
                            
                            let total = 0;
                            appState.organizations.forEach(org => { total += getMatches(org.id).length; });
                            document.getElementById('totalMatches').textContent = total;
                            
                            appState.view.on("click", e => {
                                appState.view.hitTest(e).then(r => {
                                    if (r.results.length > 0 && r.results[0].graphic.attributes?.id) {
                                        showOrgMatches(r.results[0].graphic.attributes);
                                    }
                                });
                            });
                        });
                });
            });
        }

        function toggleNetworkView() {
            appState.showNetwork = !appState.showNetwork;
            if (!appState.layers.network) return;
            
            appState.layers.network.removeAll();
            if (appState.showNetwork) {
                require(["esri/Graphic", "esri/geometry/Polyline", "esri/symbols/SimpleLineSymbol"],
                    function(Graphic, Polyline, SimpleLineSymbol) {
                        appState.organizations.forEach(org => {
                            getMatches(org.id).slice(0, 3).forEach(m => {
                                appState.layers.network.add(new Graphic({
                                    geometry: new Polyline({ paths: [[org.lng, org.lat], [m.org.lng, m.org.lat]] }),
                                    symbol: new SimpleLineSymbol({ color: [100, 200, 255, 0.3], width: 2 })
                                }));
                            });
                        });
                    });
            }
        }

        function showOrgMatches(org) {
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('matchView').classList.remove('hidden');
            const matches = getMatches(org.id);
            let html = `<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 class="text-2xl font-bold mb-2">${org.name}</h2>
                <p class="text-gray-600 mb-4">${org.type} • ${org.county}</p>
                <div class="grid md:grid-cols-2 gap-6">
                    <div><h3 class="font-semibold mb-3">Current Needs</h3>
                        ${org.topNeeds.map(n => `<div class="bg-orange-50 px-3 py-2 rounded mb-2">${n}</div>`).join('')}
                    </div>
                    <div><h3 class="font-semibold mb-3">Available Resources</h3>
                        ${org.topResources.map(r => `<div class="bg-green-50 px-3 py-2 rounded mb-2">${r}</div>`).join('')}
                    </div>
                </div></div>
                <h3 class="text-2xl font-bold mb-4">Top Matches</h3><div class="space-y-4">`;
            matches.slice(0, 5).forEach(({org: m, matchData}) => {
                html += `<div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between mb-4">
                        <div><h4 class="text-xl font-bold">${m.name}</h4>
                        <p class="text-sm text-gray-600">${m.type} • ${m.county}</p></div>
                        <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-bold">${matchData.score} pts</div>
                    </div></div>`;
            });
            html += '</div>';
            document.getElementById('matchContent').innerHTML = html;
        }

        function showMapView() {
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('matchView').classList.add('hidden');
        }

        function exportOrganizations() {
            const blob = new Blob([JSON.stringify(appState.organizations, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'food-system-organizations.json';
            a.click();
        }

        function exportMatches() {
            const matches = appState.organizations.map(org => ({
                organization: { id: org.id, name: org.name, type: org.type, county: org.county },
                topMatches: getMatches(org.id).slice(0, 10).map(m => ({
                    matchedOrg: { id: m.org.id, name: m.org.name },
                    matchScore: m.matchData.score
                }))
            }));
            const blob = new Blob([JSON.stringify(matches, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'food-system-matches.json';
            a.click();
        }

        window.addEventListener('load', initMap);
    </script>
</body>
</html>
