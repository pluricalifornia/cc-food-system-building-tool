<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Coast Food System Network Matcher</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #mapDiv {
            height: 600px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-green-800 mb-4">
                üåæ Central Coast Food System Network Matcher
            </h1>
            <p class="text-lg text-gray-600 max-w-3xl mx-auto mb-6">
                Interactive map of 100 organizations across 6 Central Coast counties
            </p>
            
            <!-- Control Buttons -->
            <div class="flex flex-wrap justify-center gap-4 mb-6">
                <button onclick="setMapView('organizations')" id="btnOrgs" class="btn px-6 py-2 rounded-lg font-semibold bg-green-600 text-white">
                    üìç Organizations
                </button>
                <button onclick="setMapView('network')" id="btnNetwork" class="btn px-6 py-2 rounded-lg font-semibold bg-white text-blue-600 border-2 border-blue-600">
                    üîó Network View
                </button>
                <button onclick="exportOrganizations()" class="btn px-6 py-2 rounded-lg font-semibold bg-purple-600 text-white">
                    ‚¨áÔ∏è Export Orgs
                </button>
                <button onclick="exportMatches()" class="btn px-6 py-2 rounded-lg font-semibold bg-indigo-600 text-white">
                    ‚¨áÔ∏è Export Matches
                </button>
                <label class="btn px-6 py-2 rounded-lg font-semibold bg-orange-600 text-white cursor-pointer">
                    ‚¨ÜÔ∏è Load Boundaries
                    <input type="file" id="boundaryUpload" accept=".json,.geojson" class="hidden" onchange="handleBoundaryUpload(event)">
                </label>
            </div>
        </div>

        <!-- Main Content -->
        <div id="mainView">
            <!-- Map View -->
            <div id="mapDiv" class="w-full rounded-lg shadow-lg border-4 border-white mb-6"></div>
            
            <!-- Legend -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4">Organization Types</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(34, 139, 34);"></div>
                        <span>Farmer/Producer</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(255, 140, 0);"></div>
                        <span>Processor</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(30, 144, 255);"></div>
                        <span>Distributor</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(147, 112, 219);"></div>
                        <span>Nonprofit</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(220, 20, 60);"></div>
                        <span>Education</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(255, 215, 0);"></div>
                        <span>Cooperative</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-4 h-4 rounded-full" style="background-color: rgb(64, 224, 208);"></div>
                        <span>Service Provider</span>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="font-bold text-lg mb-4">Quick Stats</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-3xl font-bold text-green-700">100</div>
                        <div class="text-sm text-gray-600">Organizations</div>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-3xl font-bold text-blue-700">6</div>
                        <div class="text-sm text-gray-600">Counties</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-3xl font-bold text-purple-700" id="totalMatches">0</div>
                        <div class="text-sm text-gray-600">Potential Matches</div>
                    </div>
                </div>
            </div>

            <!-- GitHub Instructions -->
            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                <h4 class="font-bold text-blue-900 mb-2">üìö GitHub Deployment Instructions</h4>
                <div class="text-sm text-blue-800 space-y-2">
                    <p><strong>1.</strong> Save this page as <code class="bg-blue-100 px-2 py-1 rounded">index.html</code></p>
                    <p><strong>2.</strong> Create a new GitHub repository</p>
                    <p><strong>3.</strong> Upload <code class="bg-blue-100 px-2 py-1 rounded">index.html</code> to the repository</p>
                    <p><strong>4.</strong> Go to Settings ‚Üí Pages ‚Üí Select main branch</p>
                    <p><strong>5.</strong> Your site will be live at <code class="bg-blue-100 px-2 py-1 rounded">https://yourusername.github.io/repo-name</code></p>
                </div>
            </div>
        </div>

        <!-- Match Details View (hidden by default) -->
        <div id="matchView" class="hidden">
            <button onclick="showMapView()" class="text-green-600 hover:text-green-800 font-semibold flex items-center gap-2 mb-6 text-lg">
                ‚Üê Back to Map
            </button>
            <div id="matchContent"></div>
        </div>
    </div>

    <script>
        // Global variables
        let organizations = [];
        let view = null;
        let orgLayer = null;
        let networkLayer = null;
        let boundaryLayer = null;
        let currentMapView = 'organizations';
        let selectedOrg = null;

        // County locations with bounds
        const countyLocations = {
            "Monterey County": { lat: 36.4, lng: -121.3, bounds: { minLat: 35.8, maxLat: 37.0, minLng: -122.0, maxLng: -120.2 } },
            "Santa Cruz County": { lat: 37.0, lng: -122.0, bounds: { minLat: 36.8, maxLat: 37.3, minLng: -122.3, maxLng: -121.6 } },
            "San Benito County": { lat: 36.6, lng: -121.0, bounds: { minLat: 36.2, maxLat: 36.9, minLng: -121.5, maxLng: -120.4 } },
            "Santa Barbara County": { lat: 34.5, lng: -120.0, bounds: { minLat: 34.4, maxLat: 35.0, minLng: -120.7, maxLng: -119.5 } },
            "San Luis Obispo County": { lat: 35.3, lng: -120.5, bounds: { minLat: 35.0, maxLat: 35.8, minLng: -121.3, maxLng: -119.8 } },
            "Ventura County": { lat: 34.4, lng: -119.1, bounds: { minLat: 34.0, maxLat: 34.7, minLng: -119.5, maxLng: -118.6 } }
        };

        const typeColors = {
            "Farmer/Fisher/Food Producer": [34, 139, 34],
            "Food Processor": [255, 140, 0],
            "Distributor": [30, 144, 255],
            "Nonprofit Organization": [147, 112, 219],
            "Educational Institution": [220, 20, 60],
            "Cooperative": [255, 215, 0],
            "For-profit Service Provider": [64, 224, 208]
        };

        // Generate unique location
        function generateUniqueLocation(county, existingLocations, minDistance = 0.05) {
            const bounds = countyLocations[county].bounds;
            let attempts = 0;
            const maxAttempts = 100;
            
            while (attempts < maxAttempts) {
                const lat = bounds.minLat + Math.random() * (bounds.maxLat - bounds.minLat);
                const lng = bounds.minLng + Math.random() * (bounds.maxLng - bounds.minLng);
                
                const tooClose = existingLocations.some(existing => {
                    const distance = Math.sqrt(
                        Math.pow(existing.lat - lat, 2) + Math.pow(existing.lng - lng, 2)
                    );
                    return distance < minDistance;
                });
                
                if (!tooClose) {
                    return { lat, lng };
                }
                attempts++;
            }
            
            return {
                lat: bounds.minLat + Math.random() * (bounds.maxLat - bounds.minLat),
                lng: bounds.minLng + Math.random() * (bounds.maxLng - bounds.minLng)
            };
        }

        // Generate organizations
        function generateOrganizations() {
            const orgTypes = [
                "Farmer/Fisher/Food Producer",
                "Food Processor",
                "Distributor",
                "Nonprofit Organization",
                "Educational Institution",
                "Cooperative",
                "For-profit Service Provider"
            ];

            const counties = Object.keys(countyLocations);
            
            const needsPool = [
                "Cold storage facility access",
                "Marketing and brand development",
                "Grant writing and fundraising",
                "Transportation and delivery services",
                "Business planning and strategy",
                "Processing and packaging capabilities",
                "Food safety certification",
                "Technology integration",
                "Access to capital/loan assistance",
                "Distribution and logistics planning",
                "E-commerce platform development",
                "Buyer relationship development",
                "Institutional sales",
                "Equipment sharing programs"
            ];

            const resourcesPool = [
                "Production planning and crop scheduling",
                "Sustainable farming practices",
                "Cold storage facility access",
                "Transportation and delivery services",
                "Marketing and brand development",
                "Grant writing and fundraising",
                "Business planning and strategy",
                "Processing and packaging capabilities",
                "Food safety certification",
                "Distribution and logistics planning",
                "Quality control and grading",
                "Partnership development",
                "Cooperative formation"
            ];

            const infrastructurePool = [
                "Cold storage space",
                "Freezer space",
                "Dry storage/warehouse",
                "Land sharing",
                "Processing equipment",
                "Packaging equipment",
                "Washing equipment",
                "Loading docks",
                "Refrigerated vehicles",
                "Office space",
                "Kitchen facilities"
            ];

            const orgNames = [
                "Valley", "Coast", "Pacific", "Central", "Regional", "Community",
                "Sustainable", "Organic", "Fresh", "Local", "Heritage", "Coastal"
            ];
            
            const orgSuffixes = [
                "Farm", "Co-op", "Processors", "Hub", "Distributors", "Services",
                "Network", "Alliance", "Collective", "Growers", "Foods", "Partners"
            ];

            const existingLocations = [];
            const orgs = [];

            for (let i = 0; i < 100; i++) {
                const county = counties[Math.floor(Math.random() * counties.length)];
                const location = generateUniqueLocation(county, existingLocations);
                existingLocations.push(location);

                const numNeeds = 3 + Math.floor(Math.random() * 4);
                const selectedNeeds = {};
                const shuffledNeeds = [...needsPool].sort(() => Math.random() - 0.5);
                const levels = ["High", "High", "Moderate", "Moderate", "Low"];
                
                for (let j = 0; j < numNeeds; j++) {
                    selectedNeeds[shuffledNeeds[j]] = levels[Math.floor(Math.random() * levels.length)];
                }

                const numResources = 2 + Math.floor(Math.random() * 4);
                const selectedResources = {};
                const shuffledResources = [...resourcesPool].sort(() => Math.random() - 0.5);
                const resourceLevels = ["Extensive", "Extensive", "Some", "Some"];
                
                for (let j = 0; j < numResources; j++) {
                    selectedResources[shuffledResources[j]] = resourceLevels[Math.floor(Math.random() * resourceLevels.length)];
                }

                const numInfra = Math.floor(Math.random() * 4);
                const selectedInfra = [];
                const shuffledInfra = [...infrastructurePool].sort(() => Math.random() - 0.5);
                for (let j = 0; j < numInfra; j++) {
                    selectedInfra.push(shuffledInfra[j]);
                }

                const topNeedsKeys = Object.entries(selectedNeeds)
                    .filter(([_, level]) => level === "High" || level === "Moderate")
                    .sort((a, b) => (a[1] === "High" ? -1 : 1))
                    .slice(0, 3)
                    .map(([key, _]) => key);

                const topResourcesKeys = Object.entries(selectedResources)
                    .sort((a, b) => (a[1] === "Extensive" ? -1 : 1))
                    .slice(0, 3)
                    .map(([key, _]) => key);

                orgs.push({
                    id: i + 1,
                    name: `${orgNames[Math.floor(Math.random() * orgNames.length)]} ${orgSuffixes[Math.floor(Math.random() * orgSuffixes.length)]}`,
                    type: orgTypes[Math.floor(Math.random() * orgTypes.length)],
                    county: county,
                    lat: location.lat,
                    lng: location.lng,
                    deliveryRadius: 20 + Math.floor(Math.random() * 80),
                    needs: selectedNeeds,
                    resources: selectedResources,
                    infrastructure: selectedInfra,
                    topNeeds: topNeedsKeys,
                    topResources: topResourcesKeys
                });
            }

            return orgs;
        }

        // Calculate match score
        function calculateMatch(org1, org2) {
            let score = 0;
            let matches = [];

            Object.keys(org1.needs).forEach(need => {
                if (org2.resources[need] && (org1.needs[need] === "High" || org1.needs[need] === "Moderate")) {
                    const weight = org1.needs[need] === "High" ? 3 : 2;
                    const resourceLevel = org2.resources[need] === "Extensive" ? 3 : 
                                         org2.resources[need] === "Some" ? 2 : 1;
                    score += weight * resourceLevel;
                    matches.push({
                        type: "need-resource",
                        item: need,
                        needLevel: org1.needs[need],
                        resourceLevel: org2.resources[need]
                    });
                }
            });

            Object.keys(org2.needs).forEach(need => {
                if (org1.resources[need] && (org2.needs[need] === "High" || org2.needs[need] === "Moderate")) {
                    const weight = org2.needs[need] === "High" ? 3 : 2;
                    const resourceLevel = org1.resources[need] === "Extensive" ? 3 : 
                                         org1.resources[need] === "Some" ? 2 : 1;
                    score += weight * resourceLevel;
                    matches.push({
                        type: "resource-need",
                        item: need,
                        needLevel: org2.needs[need],
                        resourceLevel: org1.resources[need]
                    });
                }
            });

            if (org1.county === org2.county) {
                score += 5;
            }

            return { score, matches };
        }

        // Get matches for organization
        function getMatches(orgId) {
            const org = organizations.find(o => o.id === orgId);
            const matches = organizations
                .filter(o => o.id !== orgId)
                .map(o => ({
                    org: o,
                    matchData: calculateMatch(org, o)
                }))
                .filter(m => m.matchData.score > 0)
                .sort((a, b) => b.matchData.score - a.matchData.score);
            
            return matches;
        }

        // Initialize map
        function initializeMap() {
            require([
                "esri/Map",
                "esri/views/MapView",
                "esri/Graphic",
                "esri/layers/GraphicsLayer",
                "esri/geometry/Point",
                "esri/geometry/Polyline",
                "esri/symbols/SimpleMarkerSymbol",
                "esri/symbols/SimpleLineSymbol",
                "esri/symbols/SimpleFillSymbol",
                "esri/PopupTemplate"
            ], function(Map, MapView, Graphic, GraphicsLayer, Point, Polyline, SimpleMarkerSymbol, SimpleLineSymbol, SimpleFillSymbol, PopupTemplate) {
                
                const map = new Map({
                    basemap: "streets-navigation-vector"
                });

                view = new MapView({
                    container: "mapDiv",
                    map: map,
                    center: [-121.0, 35.5],
                    zoom: 7
                });

                orgLayer = new GraphicsLayer();
                networkLayer = new GraphicsLayer();
                boundaryLayer = new GraphicsLayer();
                
                map.add(boundaryLayer);
                map.add(networkLayer);
                map.add(orgLayer);

                // Add organization markers
                organizations.forEach(org => {
                    const point = new Point({
                        longitude: org.lng,
                        latitude: org.lat
                    });

                    const markerSymbol = new SimpleMarkerSymbol({
                        color: typeColors[org.type] || [128, 128, 128],
                        size: "10px",
                        outline: {
                            color: [255, 255, 255],
                            width: 2
                        }
                    });

                    const popupTemplate = new PopupTemplate({
                        title: org.name,
                        content: `
                            <b>Type:</b> ${org.type}<br>
                            <b>County:</b> ${org.county}<br>
                            <b>Top Needs:</b><br>
                            ${org.topNeeds.map(n => `‚Ä¢ ${n}`).join('<br>')}<br>
                            <b>Top Resources:</b><br>
                            ${org.topResources.map(r => `‚Ä¢ ${r}`).join('<br>')}
                        `
                    });

                    const graphic = new Graphic({
                        geometry: point,
                        symbol: markerSymbol,
                        attributes: org,
                        popupTemplate: popupTemplate
                    });

                    orgLayer.add(graphic);
                });

                view.on("click", function(event) {
                    view.hitTest(event).then(function(response) {
                        if (response.results.length > 0) {
                            const graphic = response.results[0].graphic;
                            if (graphic.attributes && graphic.attributes.id) {
                                showOrgMatches(graphic.attributes);
                            }
                        }
                    });
                });

                // Calculate total matches
                let totalMatches = 0;
                organizations.forEach(org => {
                    totalMatches += getMatches(org.id).length;
                });
                document.getElementById('totalMatches').textContent = totalMatches;
            });
        }

        // Set map view
        function setMapView(viewType) {
            currentMapView = viewType;
            
            if (viewType === 'organizations') {
                document.getElementById('btnOrgs').className = 'btn px-6 py-2 rounded-lg font-semibold bg-green-600 text-white';
                document.getElementById('btnNetwork').className = 'btn px-6 py-2 rounded-lg font-semibold bg-white text-blue-600 border-2 border-blue-600';
                if (networkLayer) networkLayer.removeAll();
            } else {
                document.getElementById('btnOrgs').className = 'btn px-6 py-2 rounded-lg font-semibold bg-white text-green-600 border-2 border-green-600';
                document.getElementById('btnNetwork').className = 'btn px-6 py-2 rounded-lg font-semibold bg-blue-600 text-white';
                updateNetworkView();
            }
        }

        // Update network view
        function updateNetworkView() {
            require([
                "esri/Graphic",
                "esri/geometry/Polyline",
                "esri/symbols/SimpleLineSymbol"
            ], function(Graphic, Polyline, SimpleLineSymbol) {
                networkLayer.removeAll();
                
                organizations.forEach(org => {
                    const matches = getMatches(org.id).slice(0, 3);
                    
                    matches.forEach(match => {
                        const line = new Polyline({
                            paths: [
                                [org.lng, org.lat],
                                [match.org.lng, match.org.lat]
                            ]
                        });

                        const lineSymbol = new SimpleLineSymbol({
                            color: [100, 200, 255, 0.3],
                            width: Math.min(match.matchData.score / 10, 3)
                        });

                        const lineGraphic = new Graphic({
                            geometry: line,
                            symbol: lineSymbol
                        });

                        networkLayer.add(lineGraphic);
                    });
                });
            });
        }

        // Show organization matches
        function showOrgMatches(org) {
            selectedOrg = org;
            const matches = getMatches(org.id);
            
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('matchView').classList.remove('hidden');
            
            let html = `
                <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">${org.name}</h2>
                    <p class="text-gray-600 mb-4">${org.type} ‚Ä¢ ${org.county}</p>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-3">‚ö†Ô∏è Current Needs</h3>
                            <ul class="space-y-2 text-sm">
                                ${org.topNeeds.map(need => `<li class="bg-orange-50 px-3 py-2 rounded">${need}</li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-3">‚úÖ Available Resources</h3>
                            <ul class="space-y-2 text-sm">
                                ${org.topResources.map(resource => `<li class="bg-green-50 px-3 py-2 rounded">${resource}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                
                <h3 class="text-2xl font-bold text-gray-800 mb-4">üìà Top ${Math.min(matches.length, 5)} Partnership Matches</h3>
                
                <div class="space-y-4">
            `;
            
            matches.slice(0, 5).forEach(({ org: matchOrg, matchData }) => {
                html += `
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h4 class="text-xl font-bold text-gray-800">${matchOrg.name}</h4>
                                <p class="text-sm text-gray-600">${matchOrg.type} ‚Ä¢ ${matchOrg.county}</p>
                            </div>
                            <div class="text-right">
                                <div class="bg-green-100 text-green-800 px-4 py-2 rounded-lg font-bold text-lg">
                                    ${matchData.score} pts
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Match Score</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h5 class="font-semibold text-gray-700 mb-3">Collaboration Opportunities:</h5>
                            <div class="space-y-2">
                `;
                
                matchData.matches.slice(0, 3).forEach(match => {
                    if (match.type === "need-resource") {
                        html += `
                            <div class="flex items-start gap-3 text-sm">
                                <div class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-semibold flex-shrink-0">
                                    YOU NEED
                                </div>
                                <div class="flex-1">
                                    <span class="font-medium">${match.item}</span>
                                    <span class="text-gray-500"> ‚Äî ${matchOrg.name} provides </span>
                                    <span class="text-green-600 font-semibold">${match.resourceLevel}</span>
                                    <span class="text-gray-500"> support</span>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="flex items-start gap-3 text-sm">
                                <div class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-semibold flex-shrink-0">
                                    YOU PROVIDE
                                </div>
                                <div class="flex-1">
                                    <span class="font-medium">${match.item}</span>
                                    <span class="text-gray-500"> ‚Äî ${matchOrg.name} needs </span>
                                    <span class="text-orange-600 font-semibold">${match.needLevel}</span>
                                    <span class="text-gray-500"> support</span>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('matchContent').innerHTML = html;
        }

        // Show map view
        function showMapView() {
            document.getElementById('mainView').classList.remove('hidden');
            document.getElementById('matchView').classList.add('hidden');
        }

        // Export organizations
        function exportOrganizations() {
            const dataStr = JSON.stringify(organizations, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'food-system-organizations.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Export matches
        function exportMatches() {
            const allMatches = organizations.map(org => ({
                organization: {
                    id: org.id,
                    name: org.name,
                    type: org.type,
                    county: org.county
                },
                topMatches: getMatches(org.id).slice(0, 10).map(m => ({
                    matchedOrg: {
                        id: m.org.id,
                        name: m.org.name,
                        type: m.org.type,
                        county: m.org.county
                    },
                    matchScore: m.matchData.score,
                    opportunities: m.matchData.matches.slice(0, 5)
                }))
            }));

            const dataStr = JSON.stringify(allMatches, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'food-system-matches.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        // Handle boundary upload
        function handleBoundaryUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        
                        require([
                            "esri/Graphic",
                            "esri/symbols/SimpleFillSymbol"
                        ], function(Graphic, SimpleFillSymbol) {
                            boundaryLayer.removeAll();
                            
                            if (json.type === "FeatureCollection") {
                                json.features.forEach(feature => {
                                    const graphic = new Graphic({
                                        geometry: {
                                            type: "polygon",
                                            rings: feature.geometry.coordinates[0]
                                        },
                                        symbol: new SimpleFillSymbol({
                                            color: [0, 0, 0, 0],
                                            outline: {
                                                color: [100, 100, 100],
                                                width: 2
                                            }
                                        }),
                                        attributes: feature.properties
                                    });
                                    boundaryLayer.add(graphic);
                                });
                            }
                            alert('County boundaries loaded successfully!');
                        });
                    } catch (error) {
                        alert('Error parsing JSON file. Please ensure it is valid GeoJSON.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            organizations = generateOrganizations();
            initializeMap();
        });
    </script>
</body>
</html>